#!/usr/bin/env bash
set -euo pipefail

# Auto-generated backup script
# Database: {{.DB.Name}} at {{.DB.Host}}:{{.DB.Port}}

export PGHOST="{{.DB.Host}}"
export PGPORT="{{.DB.Port}}"
export PGDATABASE="{{.DB.Name}}"
export PGUSER="{{.DB.User}}"
export BACKUP_DIR="{{.BackupDir}}"

mkdir -p "${BACKUP_DIR}"

echo "Starting backup at $(date -Iseconds)"

for year in 2019 2020 2021 2022 2023 2024 2025; do
    for month in 01 02 03 04 05 06 07 08 09 10 11 12; do
{{- range $relay := .Relays}}
	# Relay: {{$relay.Name}}
{{- range $chain := $relay.Parachains}}
	for table in blocks address2blocks; do
	    tablename="chain.${table}_{{$relay.Name}}_{{$chain}}_${year}_${month}"
	    dumpfile="${BACKUP_DIR}/${tablename}.dump.gz"
	    if test ! -f "${dumpfile}"; then
		echo "Dumping ${tablename} to ${dumpfile}"
		/usr/bin/pg_dump -h "${PGHOST}" -p "${PGPORT}" -Z 7 -n chain -t "${tablename}" "${PGDATABASE}" > "${dumpfile}" 2>&1
		status=$?
		if [ $status -ne 0 ]; then
		    echo "Error with dumping ${tablename}"
		    rm -f "${dumpfile}"
		else
		    echo "Successfully dumped ${tablename}"
		fi
	    fi
	done
{{- end}}
{{- end}}
    done
done

echo "Backup completed at $(date -Iseconds)"
